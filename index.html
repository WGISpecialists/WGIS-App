<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>üîê TruckGPS Secure Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
            height: 100vh;
            margin: 0;
            display: flex;
            flex-direction: column;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
            height: 100vh;
        }
        
        .header {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 15px 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .header-center {
            flex: 1;
            text-align: center;
        }
        
        .header-center h1 {
            font-size: 1.8rem;
            margin: 0;
        }
        
        .header-center p {
            font-size: 0.9rem;
            margin: 5px 0 0 0;
        }
        
        .header-right {
            display: flex;
            gap: 10px;
        }
        
        .header-btn {
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border: none;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .header-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }
        
        .header-btn:disabled {
            background: rgba(255, 255, 255, 0.1);
            cursor: not-allowed;
            opacity: 0.6;
        }
        
        .page-info-header {
            text-align: center;
            padding: 15px 0;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1976d2;
        }
        
        .breadcrumb {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }
        
        .section h2 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        /* Page Navigation */
        .page {
            display: none;
            flex: 1;
            overflow: hidden;
        }
        
        .page.active {
            display: flex;
            flex-direction: column;
        }
        
        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .nav-btn {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background-color: #1565c0;
        }
        
        .nav-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .nav-btn.overview {
            background-color: #4caf50;
        }
        
        .nav-btn.overview:hover {
            background-color: #45a049;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1976d2;
        }
        
        .breadcrumb {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* Passcode Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal h3 {
            color: #1976d2;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .passcode-input {
            font-size: 2rem;
            text-align: center;
            padding: 15px;
            border: 3px solid #1976d2;
            border-radius: 8px;
            width: 200px;
            margin: 20px auto;
            letter-spacing: 10px;
            font-weight: bold;
        }
        
        .passcode-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 250px;
            margin: 20px auto;
        }
        
        .passcode-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .passcode-btn:hover {
            background: #1565c0;
            transform: scale(1.05);
        }
        
        .passcode-btn.clear {
            background: #f44336;
            grid-column: span 2;
        }
        
        .passcode-btn.enter {
            background: #4caf50;
        }
        
        .error-message {
            color: #f44336;
            margin-top: 10px;
            font-weight: 600;
        }
        
        .status-message {
            color: #4caf50;
            margin-top: 10px;
            font-weight: 600;
        }
        
        /* Fail Job Modal Styles */
        .fail-modal {
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .fail-form {
            margin-top: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: #333;
        }
        
        .form-select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            background-color: white;
            transition: border-color 0.3s ease;
        }
        
        .form-select:focus {
            outline: none;
            border-color: #1976d2;
        }
        
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 1rem;
            font-family: inherit;
            resize: vertical;
            min-height: 100px;
            transition: border-color 0.3s ease;
        }
        
        .form-textarea:focus {
            outline: none;
            border-color: #1976d2;
        }
        
        .char-counter {
            text-align: right;
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }
        
        .photo-upload-section {
            border: 2px dashed #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            transition: border-color 0.3s ease;
        }
        
        .photo-upload-section.dragover {
            border-color: #1976d2;
            background-color: #f3f8ff;
        }
        
        .photo-upload-area {
            text-align: center;
            cursor: pointer;
            padding: 20px;
        }
        
        .upload-placeholder {
            color: #666;
        }
        
        .upload-icon {
            font-size: 3rem;
            margin-bottom: 10px;
        }
        
        .upload-hint {
            font-size: 0.9rem;
            color: #999;
            margin-top: 5px;
        }
        
        .photo-preview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            gap: 10px;
            margin-top: 15px;
        }
        
        .photo-preview {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
            border: 2px solid #e0e0e0;
        }
        
        .photo-preview img {
            width: 100%;
            height: 120px;
            object-fit: cover;
            display: block;
        }
        
        .photo-remove {
            position: absolute;
            top: 5px;
            right: 5px;
            background: rgba(244, 67, 54, 0.9);
            color: white;
            border: none;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            cursor: pointer;
            font-size: 0.8rem;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .photo-remove:hover {
            background: #f44336;
        }
        
        .form-actions {
            display: flex;
            gap: 15px;
            justify-content: flex-end;
            margin-top: 30px;
            padding-top: 20px;
            border-top: 1px solid #e0e0e0;
        }
        
        .modal-btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            min-width: 120px;
        }
        
        .modal-btn.cancel {
            background: #f5f5f5;
            color: #666;
        }
        
        .modal-btn.cancel:hover {
            background: #e0e0e0;
        }
        
        .modal-btn.submit {
            background: #f44336;
            color: white;
        }
        
        .modal-btn.submit:hover {
            background: #d32f2f;
        }
        
        .modal-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
        }
        
        .btn-loading {
            position: absolute;
            left: 50%;
            top: 50%;
            transform: translate(-50%, -50%);
        }

        /* Overview Page Styles */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .overview-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .overview-card.claimed {
            border-color: #4caf50;
            background: #f8fff8;
        }
        
        .overview-card.available {
            border-color: #2196f3;
            background: #f3f8ff;
        }
        
        .overview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .overview-run-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1976d2;
        }
        
        .overview-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }
        
        .overview-status.available {
            background-color: #2196f3;
        }
        
        .overview-status.claimed {
            background-color: #4caf50;
        }
        
        .overview-driver {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        .overview-progress {
            margin: 15px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .progress-text {
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }
        
        .job-breakdown {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .job-stat {
            text-align: center;
        }
        
        .job-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .job-stat-number.pending { color: #2196f3; }
        .job-stat-number.started { color: #ff9800; }
        .job-stat-number.completed { color: #4caf50; }
        .job-stat-number.failed { color: #f44336; }
        
        .job-stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
        }
        
        .last-update {
            font-size: 0.8rem;
            color: #999;
            margin-top: 10px;
            text-align: center;
        }

        /* Rest of existing styles... */
        .truck-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .truck-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .truck-card:hover {
            border-color: #1976d2;
            background-color: #f3f8ff;
        }
        
        .truck-card.selected {
            border-color: #1976d2;
            background-color: #e3f2fd;
        }
        
        .truck-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .truck-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .runs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .run-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .run-card:hover {
            border-color: #1976d2;
        }
        
        .run-card.selected {
            border-color: #1976d2;
            background-color: #e3f2fd;
        }
        
        .run-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .run-number {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1976d2;
        }
        
        .run-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }
        
        .run-status.available {
            background-color: #4caf50;
        }
        
        .run-status.claimed {
            background-color: #ff9800;
        }
        
        .run-name {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .run-info {
            color: #666;
            font-size: 0.9rem;
        }
        
        .claim-btn {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .claim-btn:hover {
            background-color: #1565c0;
        }
        
        .claimed-badge {
            background-color: #4caf50;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .job-section-header {
            flex-shrink: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .job-list {
            flex: 1;
            overflow-y: auto;
            min-height: 0;
        }
        
        .job-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }
        
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .job-number {
            font-weight: 600;
            color: #1976d2;
            font-size: 1.1rem;
        }
        
        .job-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }
        
        .job-status.pending {
            background-color: #2196f3;
        }
        
        .job-status.started {
            background-color: #ff9800;
        }
        
        .job-status.completed {
            background-color: #4caf50;
        }
        
        .job-customer {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .job-address {
            color: #666;
            margin-bottom: 5px;
        }
        
        .job-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .job-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .job-btn:hover {
            transform: translateY(-1px);
        }
        
        .btn-start {
            background-color: #1976d2;
            color: white;
        }
        
        .btn-complete {
            background-color: #4caf50;
            color: white;
        }
        
        .btn-fail {
            background-color: #f44336;
            color: white;
        }
        
        .btn-call {
            background-color: #2196f3;
            color: white;
        }
        
        .btn-restore {
            background-color: #ff9800;
            color: white;
        }
        
        .btn-restore:hover {
            background-color: #f57c00;
        }
        
        .job-card.completed {
            border-left: 4px solid #4caf50;
            background: #f8fff8;
        }
        
        .job-card.failed {
            border-left: 4px solid #f44336;
            background: #fff8f8;
        }
        
        .job-notes {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .hidden {
            display: none;
        }
        
        /* Mobile Responsive Styles */
        @media (max-width: 768px) {
            .container {
                padding: 10px;
                height: 100vh;
            }
            
            .header {
                flex-direction: column;
                padding: 15px;
                margin-bottom: 15px;
                gap: 10px;
            }
            
            .header-left, .header-right {
                width: 100%;
                justify-content: center;
            }
            
            .header-center {
                order: -1;
            }
            
            .header-center h1 {
                font-size: 1.6rem;
                margin-bottom: 5px;
            }
            
            .header-center p {
                font-size: 0.85rem;
            }
            
            .header-btn {
                padding: 10px 16px;
                font-size: 0.9rem;
            }
            
            /* Page Info Header Mobile */
            .page-info-header {
                padding: 10px 0;
                margin-bottom: 15px;
            }
            
            .page-title {
                font-size: 1.3rem;
            }
            
            .breadcrumb {
                font-size: 0.8rem;
            }
            
            /* Truck Grid Mobile */
            .truck-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
                gap: 10px;
            }
            
            .truck-card {
                padding: 20px 10px;
                min-height: 80px;
            }
            
            .truck-icon {
                font-size: 1.5rem;
                margin-bottom: 8px;
            }
            
            .truck-name {
                font-size: 1rem;
            }
            
            /* Runs Grid Mobile */
            .runs-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }
            
            .run-card {
                padding: 20px;
            }
            
            .run-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .run-number {
                font-size: 1.2rem;
            }
            
            .run-status {
                align-self: flex-start;
                padding: 6px 12px;
                font-size: 0.8rem;
            }
            
            .claim-btn {
                width: 100%;
                padding: 12px;
                margin-top: 15px;
                font-size: 1rem;
                min-height: 44px;
            }
            
            /* Job Cards Mobile */
            .job-card {
                padding: 15px;
                margin-bottom: 12px;
            }
            
            .job-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .job-number {
                font-size: 1rem;
            }
            
            .job-status {
                align-self: flex-start;
                padding: 4px 8px;
                font-size: 0.75rem;
            }
            
            .job-customer {
                font-size: 1.1rem;
                margin-bottom: 8px;
                line-height: 1.3;
            }
            
            .job-address {
                font-size: 0.9rem;
                margin-bottom: 8px;
                line-height: 1.4;
            }
            
            .job-actions {
                flex-wrap: wrap;
                gap: 8px;
                margin-top: 15px;
            }
            
            .job-btn {
                flex: 1;
                min-width: 80px;
                padding: 12px 8px;
                font-size: 0.9rem;
                min-height: 44px;
                border-radius: 8px;
            }
            
            /* Overview Grid Mobile */
            .overview-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .overview-card {
                padding: 15px;
            }
            
            .overview-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
            
            .overview-run-number {
                font-size: 1.3rem;
            }
            
            .overview-status {
                align-self: flex-start;
                padding: 4px 8px;
                font-size: 0.8rem;
            }
            
            .job-breakdown {
                flex-wrap: wrap;
                justify-content: space-between;
                gap: 10px;
            }
            
            .job-stat {
                flex: 1;
                min-width: 70px;
            }
            
            .job-stat-number {
                font-size: 1.3rem;
            }
            
            .job-stat-label {
                font-size: 0.7rem;
            }
            
            /* Passcode Modal Mobile */
            .modal-content {
                margin: 20% auto;
                padding: 20px;
                width: 95%;
                max-width: 350px;
            }
            
            .passcode-input {
                font-size: 1.8rem;
                padding: 12px;
                width: 180px;
                letter-spacing: 8px;
            }
            
            .passcode-buttons {
                max-width: 220px;
                gap: 8px;
            }
            
            .passcode-btn {
                padding: 12px;
                font-size: 1.3rem;
                min-height: 44px;
            }
            
            /* Section spacing */
            .section {
                padding: 15px;
                margin-bottom: 15px;
                flex: 1;
                overflow: hidden;
            }
            
            .job-section-header {
                flex-direction: column;
                align-items: stretch;
                gap: 10px;
            }
            
            .job-section-header > div {
                display: flex;
                justify-content: center;
                gap: 10px;
            }
            
            .section h2 {
                font-size: 1.3rem;
                margin-bottom: 12px;
            }
            
            /* Loading states */
            .loading {
                padding: 30px 20px;
                font-size: 1rem;
            }
        }
        
        /* Extra small screens */
        @media (max-width: 480px) {
            .container {
                padding: 8px;
            }
            
            .header-center h1 {
                font-size: 1.4rem;
            }
            
            .header-btn {
                padding: 8px 12px;
                font-size: 0.8rem;
            }
            
            .truck-grid {
                grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
            }
            
            .truck-card {
                padding: 15px 8px;
            }
            
            .job-btn {
                font-size: 0.8rem;
                padding: 10px 6px;
            }
            
            .passcode-input {
                font-size: 1.6rem;
                width: 160px;
                letter-spacing: 6px;
            }
            
            .passcode-buttons {
                max-width: 200px;
            }
            
            /* Fail Modal Mobile */
            .fail-modal {
                width: 95%;
                max-height: 95vh;
                margin: 2.5% auto;
                padding: 15px;
            }
            
            .form-group {
                margin-bottom: 15px;
            }
            
            .form-actions {
                flex-direction: column;
                gap: 10px;
            }
            
            .modal-btn {
                width: 100%;
                padding: 14px 20px;
            }
            
            .photo-preview-grid {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
                gap: 8px;
            }
            
            .photo-preview img {
                height: 100px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <div class="header-left">
                <button class="header-btn" id="backBtn" onclick="goBack()" disabled>‚Üê Back</button>
            </div>
            <div class="header-center">
                <h1>WGIS</h1>
                <p>Secure truck selection, run management, and job tracking</p>
            </div>
            <div class="header-right">
                <button class="header-btn" id="resetBtn" onclick="resetToTruckSelection()">üè† Home</button>
            </div>
        </div>
        
        <!-- Page Info Header -->
        <div class="page-info-header">
            <div class="page-title" id="pageTitle">Run Overview</div>
            <div class="breadcrumb" id="breadcrumb">Real-time status</div>
        </div>
        
        <!-- Overview Page -->
        <div class="page active" id="overviewPage">
            <div class="section">
                <h2>üìä Live Run Overview</h2>
                <div class="overview-grid" id="overviewGrid">
                    <div class="loading">Loading run overview...</div>
                </div>
            </div>
        </div>
        
        <!-- Truck Selection Page -->
        <div class="page" id="truckSelectionPage">
            <div class="section">
                <div class="truck-grid" id="truckGrid">
                    <div class="loading">Loading trucks...</div>
                </div>
            </div>
        </div>
        
        <!-- Runs Selection Page -->
        <div class="page" id="runsSelectionPage">
            <div class="section">
                <div class="runs-grid" id="runsGrid">
                    <div class="loading">Loading runs...</div>
                </div>
            </div>
        </div>
        
        <!-- Job Management Page -->
        <div class="page" id="jobManagementPage">
            <div class="section">
                <div class="job-section-header">
                    <h2 id="jobSectionTitle">Active Jobs</h2>
                    <div>
                        <button class="nav-btn" id="toggleJobsBtn" onclick="toggleJobView()">üìã View Completed/Failed</button>
                        <button class="nav-btn" id="refreshJobsBtn" onclick="refreshJobs()" style="background-color: #4caf50;">üîÑ Refresh</button>
                    </div>
                </div>
                <div class="job-list" id="jobList">
                    <div class="loading">Loading jobs...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Passcode Modal -->
    <div id="passcodeModal" class="modal">
        <div class="modal-content">
            <h3>üîê Enter Passcode</h3>
            <p>Enter 4-digit passcode to claim run</p>
            <input type="password" id="passcodeInput" class="passcode-input" maxlength="4" readonly>
            <div class="passcode-buttons">
                <button class="passcode-btn" onclick="addDigit('1')">1</button>
                <button class="passcode-btn" onclick="addDigit('2')">2</button>
                <button class="passcode-btn" onclick="addDigit('3')">3</button>
                <button class="passcode-btn" onclick="addDigit('4')">4</button>
                <button class="passcode-btn" onclick="addDigit('5')">5</button>
                <button class="passcode-btn" onclick="addDigit('6')">6</button>
                <button class="passcode-btn" onclick="addDigit('7')">7</button>
                <button class="passcode-btn" onclick="addDigit('8')">8</button>
                <button class="passcode-btn" onclick="addDigit('9')">9</button>
                <button class="passcode-btn clear" onclick="clearPasscode()">Clear</button>
                <button class="passcode-btn" onclick="addDigit('0')">0</button>
            </div>
            <button class="passcode-btn enter" onclick="submitPasscode()">Enter</button>
            <div id="passcodeError" class="error-message"></div>
        </div>
    </div>
    
    <!-- Fail Job Modal -->
    <div id="failJobModal" class="modal">
        <div class="modal-content fail-modal">
            <h3>‚ùå Document Failed Delivery</h3>
            <p>Please provide details about the delivery failure</p>
            
            <div class="fail-form">
                <div class="form-group">
                    <label for="rejectionReason">Rejection Reason *</label>
                    <select id="rejectionReason" class="form-select" required>
                        <option value="">Select rejection reason...</option>
                        <option value="Successful Delivery. Item left on site, but an issue needs attention.">Successful Delivery. Item left on site, but an issue needs attention.</option>
                        <option value="Item rejected, return to warehouse.">Item rejected, return to warehouse.</option>
                        <option value="No one onsite to accept delivery.">No one onsite to accept delivery.</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="failureCode">Failure Code *</label>
                    <select id="failureCode" class="form-select" required>
                        <option value="">Select failure code...</option>
                        <option value="DM1">DM1 - Damaged from Factory</option>
                        <option value="DS3">DS3 - Customer Not Home -Order Rekey</option>
                        <option value="KOB">KOB - Keep on Board</option>
                        <option value="UNSURE">UNSURE</option>
                        <option value="FA2">FA2 - Functional Failure</option>
                        <option value="AD1">AD1 - Admin -Intra Company C/Notes</option>
                        <option value="AD2">AD2 - Admin -Pro-rata Adjustment</option>
                        <option value="CD1">CD1 - Order Cancelled (Rejected)</option>
                        <option value="CD2">CD2 - Order Cancelled (Restock Fee)</option>
                        <option value="DS1">DS1 - No P.O.D</option>
                        <option value="DE1">DE1 - Duplicated Order</option>
                        <option value="DS2">DS2 - Delivery Sent to Wrong Address</option>
                        <option value="DM2">DM2 - Damaged in Transit</option>
                        <option value="DM3">DM3 - Damaged by Customer</option>
                        <option value="FA1">FA1 - Faulty Product</option>
                        <option value="IN1">IN1 - Incorrect Product Sent</option>
                        <option value="IN2">IN2 - Incomplete Order</option>
                        <option value="MO1">MO1 - Missing Order</option>
                        <option value="NO1">NO1 - Not Ordered by Customer</option>
                        <option value="PA1">PA1 - Payment Issue</option>
                        <option value="QU1">QU1 - Quality Issue</option>
                        <option value="RE1">RE1 - Refused by Customer</option>
                        <option value="SI1">SI1 - Size Issue</option>
                        <option value="TI1">TI1 - Timing Issue</option>
                        <option value="WR1">WR1 - Wrong Product</option>
                        <option value="AC1">AC1 - Access Issue</option>
                        <option value="WE1">WE1 - Weather Related</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label for="failureNotes">Driver Notes</label>
                    <textarea id="failureNotes" class="form-textarea" placeholder="Enter additional details about the delivery failure..." maxlength="500"></textarea>
                    <div class="char-counter">
                        <span id="charCount">0</span>/500 characters
                    </div>
                </div>
                
                <div class="form-group">
                    <label>Photos (Optional - Up to 5)</label>
                    <div class="photo-upload-section">
                        <div class="photo-upload-area" id="photoUploadArea">
                            <div class="upload-placeholder">
                                <div class="upload-icon">üì∑</div>
                                <p>Click to select photos or drag & drop</p>
                                <p class="upload-hint">JPEG/PNG ‚Ä¢ Max 5 photos ‚Ä¢ 10MB each</p>
                            </div>
                            <input type="file" id="photoInput" accept="image/jpeg,image/png" multiple style="display: none;">
                        </div>
                        <div class="photo-preview-grid" id="photoPreviewGrid"></div>
                    </div>
                </div>
                
                <div class="form-actions">
                    <button class="modal-btn cancel" onclick="hideFailJobModal()">Cancel</button>
                    <button class="modal-btn submit" onclick="submitFailedDelivery()" id="submitFailBtn">
                        <span class="btn-text">Submit Failure Report</span>
                        <span class="btn-loading" style="display: none;">‚è≥ Processing...</span>
                    </button>
                </div>
                
                <div id="failJobError" class="error-message"></div>
                <div id="failJobStatus" class="status-message"></div>
            </div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <!-- EmailJS SDK -->
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBTPg2rlz0MvkYH9H-nEpIkPQ0WGDdEr8M",
            authDomain: "wgis-fb191.firebaseapp.com",
            projectId: "wgis-fb191",
            storageBucket: "wgis-fb191.firebasestorage.app",
            messagingSenderId: "858064992862",
            appId: "1:858064992862:android:6c50005973aa483b4a52cf"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Initialize EmailJS
        emailjs.init('glzGNdjIcgbVEsJwH'); // Public key from Android app
        
        // Global state
        let selectedTruck = null;
        let selectedRun = null;
        let availableRuns = {};
        let currentJobs = {};
        let pendingRunKey = null;
        let showingCompletedJobs = false;
        
        // Page navigation state
        let currentPage = 'overview'; // Start with overview
        
        // Security
        const PASSCODE = '1289';
        
        // Default truck list
        const defaultTrucks = [
            '532 RXW',
            '660 WWG', 
            '723 VMV',
            'XQ44 TB',
            'RENTAL TRUCK 1',
            'RENTAL TRUCK 2',
            'UTE'
        ];
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            restoreSession();
            loadTrucks();
            loadOverview();
            updatePageNavigation();
            
            // Auto-refresh overview every 30 seconds
            setInterval(loadOverview, 30000);
        });
        
        // Security functions
        function showPasscodeModal(runKey) {
            pendingRunKey = runKey;
            document.getElementById('passcodeModal').style.display = 'block';
            document.getElementById('passcodeInput').value = '';
            document.getElementById('passcodeError').textContent = '';
        }
        
        function hidePasscodeModal() {
            document.getElementById('passcodeModal').style.display = 'none';
            pendingRunKey = null;
        }
        
        function addDigit(digit) {
            const input = document.getElementById('passcodeInput');
            if (input.value.length < 4) {
                input.value += digit;
                if (input.value.length === 4) {
                    setTimeout(submitPasscode, 200);
                }
            }
        }
        
        function clearPasscode() {
            document.getElementById('passcodeInput').value = '';
            document.getElementById('passcodeError').textContent = '';
        }
        
        function submitPasscode() {
            const input = document.getElementById('passcodeInput');
            const error = document.getElementById('passcodeError');
            
            if (input.value === PASSCODE) {
                if (pendingRunKey) {
                    proceedWithClaim(pendingRunKey);
                }
                hidePasscodeModal();
            } else {
                error.textContent = 'Incorrect passcode. Try again.';
                input.value = '';
                // Shake effect
                input.style.animation = 'shake 0.5s';
                setTimeout(() => { input.style.animation = ''; }, 500);
            }
        }
        
        // Add shake animation to CSS (we'll add this dynamically)
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);
        
        // Session persistence functions
        function saveSession() {
            const sessionData = {
                selectedTruck,
                selectedRun,
                currentPage,
                timestamp: Date.now()
            };
            localStorage.setItem('truckgps_session', JSON.stringify(sessionData));
        }
        
        function restoreSession() {
            try {
                const sessionData = JSON.parse(localStorage.getItem('truckgps_session'));
                if (!sessionData) return;
                
                // Session expires after 8 hours
                const sessionAge = Date.now() - sessionData.timestamp;
                if (sessionAge > 8 * 60 * 60 * 1000) {
                    localStorage.removeItem('truckgps_session');
                    return;
                }
                
                // Restore session state
                selectedTruck = sessionData.selectedTruck;
                selectedRun = sessionData.selectedRun;
                currentPage = sessionData.currentPage;
                
                console.log('üîÑ Session restored:', sessionData);
                
                // Navigate to the correct page
                if (currentPage === 'truck-selection' && selectedTruck) {
                    showPage('truckSelectionPage');
                } else if (currentPage === 'runs-selection' && selectedTruck) {
                    showPage('runsSelectionPage');
                    setTimeout(() => loadRuns(), 100);
                } else if (currentPage === 'job-management' && selectedTruck && selectedRun) {
                    showPage('jobManagementPage');
                    setTimeout(() => {
                        loadRuns().then(() => loadJobs(selectedRun));
                    }, 100);
                } else {
                    // Default to overview
                    currentPage = 'overview';
                    showPage('overviewPage');
                }
                
            } catch (error) {
                console.error('Error restoring session:', error);
                localStorage.removeItem('truckgps_session');
            }
        }
        
        function clearSession() {
            localStorage.removeItem('truckgps_session');
        }
        
        // Overview functions
        async function loadOverview() {
            const overviewGrid = document.getElementById('overviewGrid');
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const runsDoc = await db.collection('daily_runs').doc(today).get();
                
                if (runsDoc.exists) {
                    const data = runsDoc.data();
                    availableRuns = data.runs || {};
                    displayOverview();
                } else {
                    overviewGrid.innerHTML = '<div class="loading">No runs available for today</div>';
                }
            } catch (error) {
                console.error('Error loading overview:', error);
                overviewGrid.innerHTML = '<div class="loading">Error loading overview</div>';
            }
        }
        
        function displayOverview() {
            const overviewGrid = document.getElementById('overviewGrid');
            overviewGrid.innerHTML = '';
            
            if (Object.keys(availableRuns).length === 0) {
                overviewGrid.innerHTML = '<div class="loading">No runs available</div>';
                return;
            }
            
            Object.entries(availableRuns).forEach(([runKey, runData]) => {
                const overviewCard = document.createElement('div');
                const isAvailable = !runData.claimed_by;
                overviewCard.className = `overview-card ${isAvailable ? 'available' : 'claimed'}`;
                
                const runNumber = runData.run_number || runKey;
                const jobCount = runData.job_count || 0;
                
                // Calculate job statistics
                let jobStats = { pending: 0, started: 0, completed: 0, failed: 0 };
                let progressPercentage = 0;
                
                if (runData.jobs && Array.isArray(runData.jobs)) {
                    runData.jobs.forEach(job => {
                        const status = job.status || 'pending';
                        if (jobStats.hasOwnProperty(status)) {
                            jobStats[status]++;
                        }
                    });
                    
                    const totalCompleted = jobStats.completed + jobStats.failed;
                    progressPercentage = jobCount > 0 ? Math.round((totalCompleted / jobCount) * 100) : 0;
                }
                
                const statusClass = isAvailable ? 'available' : 'claimed';
                const statusText = isAvailable ? 'AVAILABLE' : 'CLAIMED';
                const driverText = runData.driver_name || runData.claimed_by || 'Unassigned';
                
                // Format last update time
                let lastUpdateText = 'No updates';
                if (runData.last_job_update) {
                    const lastUpdate = runData.last_job_update.toDate ? runData.last_job_update.toDate() : new Date(runData.last_job_update);
                    lastUpdateText = `Updated ${lastUpdate.toLocaleTimeString()}`;
                }
                
                overviewCard.innerHTML = `
                    <div class="overview-header">
                        <div class="overview-run-number">Run ${runNumber}</div>
                        <div class="overview-status ${statusClass}">${statusText}</div>
                    </div>
                    ${!isAvailable ? `<div class="overview-driver">üë§ ${driverText}</div>` : ''}
                    <div class="overview-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="progress-text">${progressPercentage}% Complete (${jobStats.completed + jobStats.failed}/${jobCount} jobs)</div>
                    </div>
                    <div class="job-breakdown">
                        <div class="job-stat">
                            <div class="job-stat-number pending">${jobStats.pending}</div>
                            <div class="job-stat-label">Pending</div>
                        </div>
                        <div class="job-stat">
                            <div class="job-stat-number started">${jobStats.started}</div>
                            <div class="job-stat-label">Started</div>
                        </div>
                        <div class="job-stat">
                            <div class="job-stat-number completed">${jobStats.completed}</div>
                            <div class="job-stat-label">Complete</div>
                        </div>
                        <div class="job-stat">
                            <div class="job-stat-number failed">${jobStats.failed}</div>
                            <div class="job-stat-label">Failed</div>
                        </div>
                    </div>
                    <div class="last-update">${lastUpdateText}</div>
                `;
                
                overviewGrid.appendChild(overviewCard);
            });
        }
        
        function showOverview() {
            currentPage = 'overview';
            showPage('overviewPage');
            loadOverview();
            saveSession();
        }
        
        // Page navigation functions
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update navigation state
            updatePageNavigation();
        }
        
        function updatePageNavigation() {
            const backBtn = document.getElementById('backBtn');
            const pageTitle = document.getElementById('pageTitle');
            const breadcrumb = document.getElementById('breadcrumb');
            
            switch(currentPage) {
                case 'overview':
                    backBtn.disabled = true;
                    pageTitle.textContent = 'Run Overview';
                    breadcrumb.textContent = 'Real-time status';
                    break;
                case 'truck-selection':
                    backBtn.disabled = false;
                    pageTitle.textContent = 'Select Your Truck';
                    breadcrumb.textContent = 'Step 1 of 3';
                    break;
                case 'runs-selection':
                    backBtn.disabled = false;
                    pageTitle.textContent = `Available Runs - ${selectedTruck}`;
                    breadcrumb.textContent = 'Step 2 of 3';
                    break;
                case 'job-management':
                    backBtn.disabled = false;
                    pageTitle.textContent = `Job Management - Run ${availableRuns[selectedRun]?.run_number || selectedRun}`;
                    breadcrumb.textContent = 'Step 3 of 3 - Managing Jobs';
                    break;
            }
        }
        
        function goBack() {
            switch(currentPage) {
                case 'truck-selection':
                    currentPage = 'overview';
                    showPage('overviewPage');
                    break;
                case 'runs-selection':
                    currentPage = 'truck-selection';
                    selectedTruck = null;
                    showPage('truckSelectionPage');
                    break;
                case 'job-management':
                    currentPage = 'runs-selection';
                    selectedRun = null;
                    showPage('runsSelectionPage');
                    break;
            }
            saveSession();
        }
        
        function resetToTruckSelection() {
            currentPage = 'truck-selection';
            selectedTruck = null;
            selectedRun = null;
            availableRuns = {};
            currentJobs = {};
            showPage('truckSelectionPage');
            
            // Clear session
            clearSession();
            
            // Clear truck selection UI
            document.querySelectorAll('.truck-card').forEach(card => {
                card.classList.remove('selected');
            });
        }
        
        // Load available trucks
        async function loadTrucks() {
            try {
                // Try to load trucks from Firebase first
                const trucksDoc = await db.collection('config').doc('trucks').get();
                
                let trucks = defaultTrucks;
                if (trucksDoc.exists) {
                    const trucksData = trucksDoc.data();
                    if (trucksData.available_trucks && trucksData.available_trucks.length > 0) {
                        trucks = trucksData.available_trucks.map(truck => 
                            typeof truck === 'object' ? truck.rego : truck
                        );
                    }
                }
                
                displayTrucks(trucks);
            } catch (error) {
                console.error('Error loading trucks:', error);
                displayTrucks(defaultTrucks);
            }
        }
        
        // Display truck selection
        function displayTrucks(trucks) {
            const truckGrid = document.getElementById('truckGrid');
            truckGrid.innerHTML = '';
            
            trucks.forEach(truck => {
                const truckCard = document.createElement('div');
                truckCard.className = 'truck-card';
                truckCard.innerHTML = `
                    <div class="truck-icon">üöõ</div>
                    <div class="truck-name">${truck}</div>
                `;
                truckCard.onclick = () => selectTruck(truck);
                truckGrid.appendChild(truckCard);
            });
        }
        
        // Select truck
        function selectTruck(truck) {
            selectedTruck = truck;
            
            // Update UI
            document.querySelectorAll('.truck-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.truck-card').classList.add('selected');
            
            // Navigate to runs selection page
            currentPage = 'runs-selection';
            showPage('runsSelectionPage');
            
            // Save session
            saveSession();
            
            // Load runs for this date
            loadRuns();
        }
        
        // Load available runs
        async function loadRuns() {
            if (!selectedTruck) return;
            
            const runsGrid = document.getElementById('runsGrid');
            runsGrid.innerHTML = '<div class="loading">Loading runs...</div>';
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const runsDoc = await db.collection('daily_runs').doc(today).get();
                
                if (runsDoc.exists) {
                    const data = runsDoc.data();
                    availableRuns = data.runs || {};
                    displayRuns();
                } else {
                    runsGrid.innerHTML = '<div class="loading">No runs available for today</div>';
                }
            } catch (error) {
                console.error('Error loading runs:', error);
                runsGrid.innerHTML = '<div class="loading">Error loading runs</div>';
            }
        }
        
        // Display runs
        function displayRuns() {
            const runsGrid = document.getElementById('runsGrid');
            runsGrid.innerHTML = '';
            
            if (Object.keys(availableRuns).length === 0) {
                runsGrid.innerHTML = '<div class="loading">No runs available</div>';
                return;
            }
            
            Object.entries(availableRuns).forEach(([runKey, runData]) => {
                const runCard = document.createElement('div');
                runCard.className = 'run-card';
                
                const runNumber = runData.run_number || runKey;
                const jobCount = runData.job_count || 0;
                const isAvailable = !runData.claimed_by;
                const isClaimedByMe = runData.driver_name === selectedTruck;
                
                let statusClass = 'available';
                let statusText = 'AVAILABLE';
                let actionButton = `<button class="claim-btn" onclick="claimRun('${runKey}')">üîê Secure Claim</button>`;
                
                if (runData.claimed_by) {
                    if (isClaimedByMe) {
                        statusClass = 'available';
                        statusText = 'YOURS';
                        actionButton = '<div class="claimed-badge">Your Run</div>';
                    } else {
                        statusClass = 'claimed';
                        statusText = `CLAIMED BY ${runData.driver_name || runData.claimed_by}`;
                        actionButton = '';
                    }
                }
                
                runCard.innerHTML = `
                    <div class="run-header">
                        <div class="run-number">Run ${runNumber}</div>
                        <div class="run-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="run-name">${runData.run_name || 'Unknown Run'}</div>
                    <div class="run-info">${jobCount} jobs</div>
                    ${actionButton}
                `;
                
                if (isClaimedByMe) {
                    runCard.onclick = () => selectRun(runKey, runData);
                }
                
                runsGrid.appendChild(runCard);
            });
        }
        
        // Claim a run (with passcode protection)
        function claimRun(runKey) {
            if (!selectedTruck) return;
            showPasscodeModal(runKey);
        }
        
        // Proceed with claiming after passcode verification
        async function proceedWithClaim(runKey) {
            try {
                const today = new Date().toISOString().split('T')[0];
                await db.collection('daily_runs').doc(today).update({
                    [`runs.${runKey}.claimed_by`]: `web_${selectedTruck}`,
                    [`runs.${runKey}.driver_name`]: selectedTruck,
                    [`runs.${runKey}.claimed_at`]: firebase.firestore.FieldValue.serverTimestamp(),
                    [`runs.${runKey}.status`]: 'claimed'
                });
                
                console.log(`üîê Run ${runKey} securely claimed by ${selectedTruck}`);
                
                // Automatically navigate to job management after claiming
                selectedRun = runKey;
                currentPage = 'job-management';
                showPage('jobManagementPage');
                
                // Save session
                saveSession();
                
                loadJobs(runKey);
                
            } catch (error) {
                console.error('Error claiming run:', error);
                alert('Error claiming run. Please try again.');
            }
        }
        
        // Select and load run jobs
        async function selectRun(runKey, runData) {
            selectedRun = runKey;
            
            // Update UI
            document.querySelectorAll('.run-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.run-card').classList.add('selected');
            
            // Navigate to job management page
            currentPage = 'job-management';
            showPage('jobManagementPage');
            
            // Save session
            saveSession();
            
            // Load jobs for this run
            loadJobs(runKey);
        }
        
        // Load jobs for selected run
        async function loadJobs(runKey) {
            const jobList = document.getElementById('jobList');
            jobList.innerHTML = '<div class="loading">Loading jobs...</div>';
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const jobsDoc = await db.collection('daily_runs').doc(today).get();
                
                if (jobsDoc.exists) {
                    const data = jobsDoc.data();
                    const runData = data.runs[runKey];
                    if (runData && runData.jobs) {
                        currentJobs = runData.jobs;
                        displayJobs();
                    } else {
                        jobList.innerHTML = '<div class="loading">No jobs found for this run</div>';
                    }
                } else {
                    jobList.innerHTML = '<div class="loading">No jobs available</div>';
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
                jobList.innerHTML = '<div class="loading">Error loading jobs</div>';
            }
        }
        
        // Toggle between active and completed/failed jobs
        function toggleJobView() {
            showingCompletedJobs = !showingCompletedJobs;
            const toggleBtn = document.getElementById('toggleJobsBtn');
            const sectionTitle = document.getElementById('jobSectionTitle');
            
            if (showingCompletedJobs) {
                toggleBtn.textContent = 'üìã View Active Jobs';
                sectionTitle.textContent = 'Completed & Failed Jobs';
            } else {
                toggleBtn.textContent = 'üìã View Completed/Failed';
                sectionTitle.textContent = 'Active Jobs';
            }
            
            displayJobs();
        }
        
        // Refresh jobs (reload from Firebase)
        function refreshJobs() {
            if (selectedRun) {
                loadJobs(selectedRun);
            }
        }
        
        // Display jobs (now with toggle support)
        function displayJobs() {
            const jobList = document.getElementById('jobList');
            jobList.innerHTML = '';
            
            if (!currentJobs || currentJobs.length === 0) {
                jobList.innerHTML = '<div class="loading">No jobs available</div>';
                return;
            }
            
            // Filter jobs based on current view
            let jobsToShow;
            if (showingCompletedJobs) {
                jobsToShow = currentJobs.filter(job => 
                    job.status === 'completed' || job.status === 'failed'
                );
            } else {
                jobsToShow = currentJobs.filter(job => 
                    job.status === 'pending' || job.status === 'started'
                );
            }
            
            if (jobsToShow.length === 0) {
                const message = showingCompletedJobs ? 
                    'No completed or failed jobs' : 
                    'No active jobs';
                jobList.innerHTML = `<div class="loading">${message}</div>`;
                return;
            }
            
            jobsToShow.forEach((job) => {
                // Find original index in currentJobs array
                const originalIndex = currentJobs.findIndex(j => 
                    j.job_no === job.job_no && j.name === job.name
                );
                
                const jobCard = document.createElement('div');
                jobCard.className = `job-card ${job.status}`;
                
                const status = job.status || 'pending';
                let statusClass = status;
                
                const phoneDisplay = job.phone && job.phone !== 'STORE' ? job.phone : null;
                
                // Format completion/failure time
                let timeInfo = '';
                if (job.completed_at || job.failed_at) {
                    const timestamp = job.completed_at || job.failed_at;
                    const time = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    timeInfo = `<div class="job-address">üïí ${status === 'completed' ? 'Completed' : 'Failed'} at ${time.toLocaleTimeString()}</div>`;
                }
                
                // Show driver notes if available
                let notesDisplay = '';
                if (job.driver_notes && job.driver_notes.trim()) {
                    notesDisplay = `<div class="job-notes">üí¨ Notes: ${job.driver_notes}</div>`;
                }
                
                // Show failure reason if available
                let failureDisplay = '';
                if (job.failure_reason && job.failure_reason.trim()) {
                    failureDisplay = `<div class="job-notes">‚ùå Failure reason: ${job.failure_reason}</div>`;
                }
                
                jobCard.innerHTML = `
                    <div class="job-header">
                        <div class="job-number">#${job.job_no || (originalIndex + 1)}</div>
                        <div class="job-status ${statusClass}">${status.toUpperCase()}</div>
                    </div>
                    <div class="job-customer">${job.name || 'Unknown Customer'}</div>
                    <div class="job-address">${job.full_address || job.address || 'No address'}</div>
                    ${job.product ? `<div class="job-address">üì¶ ${job.product}</div>` : ''}
                    ${job.time ? `<div class="job-address">‚è∞ ${job.time}</div>` : ''}
                    ${phoneDisplay ? `<div class="job-address">üìû ${phoneDisplay}</div>` : ''}
                    ${timeInfo}
                    ${notesDisplay}
                    ${failureDisplay}
                    <div class="job-actions">
                        ${!showingCompletedJobs && phoneDisplay ? `<button class="job-btn btn-call" onclick="callCustomer('${phoneDisplay}', '${job.name}')">Call</button>` : ''}
                        ${!showingCompletedJobs && status === 'pending' ? `<button class="job-btn btn-start" onclick="startJob(${originalIndex})">Start</button>` : ''}
                        ${!showingCompletedJobs && status === 'started' ? `<button class="job-btn btn-complete" onclick="completeJob(${originalIndex})">Complete</button>` : ''}
                        ${!showingCompletedJobs && status === 'started' ? `<button class="job-btn btn-fail" onclick="failJob(${originalIndex})">Fail</button>` : ''}
                        ${showingCompletedJobs ? `<button class="job-btn btn-restore" onclick="restoreJob(${originalIndex})">üîÑ Restore to Active</button>` : ''}
                    </div>
                `;
                
                jobList.appendChild(jobCard);
            });
        }
        
        // Restore a completed/failed job back to pending status
        async function restoreJob(jobIndex) {
            const job = currentJobs[jobIndex];
            const confirmMessage = `Restore "${job.name}" back to active jobs?\n\nThis will reset the job to pending status and remove completion/failure data.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                console.log(`üîÑ RESTORE: Restoring job ${jobIndex} (${job.name}) to pending status`);
                
                const today = new Date().toISOString().split('T')[0];
                const docRef = db.collection('daily_runs').doc(today);
                const doc = await docRef.get();
                
                if (!doc.exists) {
                    alert('Run data not found');
                    return;
                }
                
                const data = doc.data();
                const runData = data.runs[selectedRun];
                
                if (!runData || !runData.jobs || !Array.isArray(runData.jobs)) {
                    alert('Job data not found');
                    return;
                }
                
                // Create updated jobs array
                const updatedJobs = [...runData.jobs];
                const originalJob = updatedJobs[jobIndex];
                
                // Reset job to pending state, preserving core data
                updatedJobs[jobIndex] = {
                    ...originalJob,
                    status: 'pending',
                    completed_at: null,
                    failed_at: null,
                    driver_notes: '', // Clear notes
                    failure_reason: '', // Clear failure reason
                    last_updated: new Date()
                };
                
                console.log('‚úÖ Restored job data:', updatedJobs[jobIndex]);
                
                // Update Firebase
                const updateData = {
                    [`runs.${selectedRun}.jobs`]: updatedJobs,
                    [`runs.${selectedRun}.last_job_update`]: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await docRef.update(updateData);
                console.log(`üéâ SUCCESS: Job "${job.name}" restored to pending status!`);
                
                // Refresh the display
                loadJobs(selectedRun);
                
                // Show success message
                setTimeout(() => {
                    alert(`‚úÖ Job "${job.name}" has been restored to active jobs!`);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error restoring job:', error);
                alert(`Error restoring job: ${error.message}`);
            }
        }
        
        // Job actions
        function callCustomer(phone, name) {
            window.open(`tel:${phone}`, '_self');
        }
        
        async function startJob(jobIndex) {
            await updateJobStatusSafely(jobIndex, 'started');
        }
        
        async function completeJob(jobIndex) {
            const notes = prompt('Add completion notes (optional):');
            await updateJobStatusSafely(jobIndex, 'completed', { driver_notes: notes || '' });
        }
        
        // Global variables for fail job modal
        let currentFailJobIndex = null;
        let selectedPhotos = [];
        
        async function failJob(jobIndex) {
            currentFailJobIndex = jobIndex;
            selectedPhotos = [];
            showFailJobModal();
        }
        
        function showFailJobModal() {
            // Reset form
            document.getElementById('rejectionReason').value = '';
            document.getElementById('failureCode').value = '';
            document.getElementById('failureNotes').value = '';
            document.getElementById('charCount').textContent = '0';
            document.getElementById('photoPreviewGrid').innerHTML = '';
            document.getElementById('failJobError').textContent = '';
            document.getElementById('failJobStatus').textContent = '';
            
            // Show modal
            document.getElementById('failJobModal').style.display = 'block';
        }
        
        function hideFailJobModal() {
            document.getElementById('failJobModal').style.display = 'none';
            currentFailJobIndex = null;
            selectedPhotos = [];
        }
        
        // Initialize fail modal event listeners
        document.addEventListener('DOMContentLoaded', function() {
            // Character counter for notes
            const notesTextarea = document.getElementById('failureNotes');
            const charCount = document.getElementById('charCount');
            notesTextarea.addEventListener('input', function() {
                charCount.textContent = this.value.length;
            });
            
            // Photo upload functionality
            const photoUploadArea = document.getElementById('photoUploadArea');
            const photoInput = document.getElementById('photoInput');
            
            photoUploadArea.addEventListener('click', () => photoInput.click());
            photoInput.addEventListener('change', handlePhotoSelection);
            
            // Drag and drop functionality
            photoUploadArea.addEventListener('dragover', handleDragOver);
            photoUploadArea.addEventListener('drop', handlePhotoDrop);
            photoUploadArea.addEventListener('dragleave', handleDragLeave);
        });
        
        function handleDragOver(e) {
            e.preventDefault();
            document.getElementById('photoUploadArea').parentElement.classList.add('dragover');
        }
        
        function handleDragLeave(e) {
            e.preventDefault();
            document.getElementById('photoUploadArea').parentElement.classList.remove('dragover');
        }
        
        function handlePhotoDrop(e) {
            e.preventDefault();
            document.getElementById('photoUploadArea').parentElement.classList.remove('dragover');
            const files = Array.from(e.dataTransfer.files);
            processPhotoFiles(files);
        }
        
        function handlePhotoSelection(e) {
            const files = Array.from(e.target.files);
            processPhotoFiles(files);
        }
        
        function processPhotoFiles(files) {
            const validFiles = files.filter(file => {
                // Check file type
                if (!file.type.startsWith('image/')) {
                    showError('Only image files are allowed');
                    return false;
                }
                
                // Check file size (10MB limit)
                if (file.size > 10 * 1024 * 1024) {
                    showError(`File ${file.name} is too large. Maximum size is 10MB.`);
                    return false;
                }
                
                return true;
            });
            
            // Check total photo limit
            if (selectedPhotos.length + validFiles.length > 5) {
                showError('Maximum 5 photos allowed');
                return;
            }
            
            validFiles.forEach(file => {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const photoData = {
                        file: file,
                        dataUrl: e.target.result,
                        name: file.name
                    };
                    
                    selectedPhotos.push(photoData);
                    displayPhotoPreview(photoData, selectedPhotos.length - 1);
                };
                reader.readAsDataURL(file);
            });
        }
        
        function displayPhotoPreview(photoData, index) {
            const previewGrid = document.getElementById('photoPreviewGrid');
            
            const photoPreview = document.createElement('div');
            photoPreview.className = 'photo-preview';
            photoPreview.innerHTML = `
                <img src="${photoData.dataUrl}" alt="Photo ${index + 1}">
                <button class="photo-remove" onclick="removePhoto(${index})" title="Remove photo">√ó</button>
            `;
            
            previewGrid.appendChild(photoPreview);
        }
        
        function removePhoto(index) {
            selectedPhotos.splice(index, 1);
            refreshPhotoPreview();
        }
        
        function refreshPhotoPreview() {
            const previewGrid = document.getElementById('photoPreviewGrid');
            previewGrid.innerHTML = '';
            
            selectedPhotos.forEach((photoData, index) => {
                displayPhotoPreview(photoData, index);
            });
        }
        
        function showError(message) {
            document.getElementById('failJobError').textContent = message;
            setTimeout(() => {
                document.getElementById('failJobError').textContent = '';
            }, 5000);
        }
        
        function showStatus(message) {
            document.getElementById('failJobStatus').textContent = message;
        }
        
        async function submitFailedDelivery() {
            // Validate required fields
            const rejectionReason = document.getElementById('rejectionReason').value;
            const failureCode = document.getElementById('failureCode').value;
            const failureNotes = document.getElementById('failureNotes').value;
            
            if (!rejectionReason) {
                showError('Please select a rejection reason');
                return;
            }
            
            if (!failureCode) {
                showError('Please select a failure code');
                return;
            }
            
            // Show loading state
            const submitBtn = document.getElementById('submitFailBtn');
            const btnText = submitBtn.querySelector('.btn-text');
            const btnLoading = submitBtn.querySelector('.btn-loading');
            
            submitBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoading.style.display = 'block';
            
            showStatus('Processing failure report...');
            
            try {
                // Step 1: Upload photos if any
                let photoUrls = [];
                if (selectedPhotos.length > 0) {
                    showStatus('Uploading photos...');
                    photoUrls = await uploadFailurePhotos();
                }
                
                // Step 2: Send email notification
                showStatus('Sending email notification...');
                const job = currentJobs[currentFailJobIndex];
                await sendFailureEmail(job, rejectionReason, failureCode, failureNotes, photoUrls);
                
                // Step 3: Update job status in Firebase
                showStatus('Updating job status...');
                const failureDetails = {
                    failure_type: photoUrls.length > 0 ? "cancelled_with_photo" : "cancelled_without_photo",
                    rejection_reason: rejectionReason,
                    failure_code: failureCode,
                    driver_comments: failureNotes,
                    photo_urls: photoUrls,
                    photo_count: photoUrls.length,
                    photo_url: photoUrls[0] || "", // Primary photo for backward compatibility
                    timestamp: new Date().toISOString(),
                    device_id: "web_" + selectedTruck
                };
                
                await updateJobStatusSafely(currentFailJobIndex, 'failed', {
                    driver_notes: failureNotes,
                    failure_reason: rejectionReason,
                    failure_details: failureDetails,
                    failed_at: new Date()
                });
                
                showStatus('‚úÖ Failure report submitted successfully!');
                
                // Close modal after short delay
                setTimeout(() => {
                    hideFailJobModal();
                }, 1500);
                
            } catch (error) {
                console.error('Error submitting failure report:', error);
                showError('Failed to submit report: ' + error.message);
            } finally {
                // Reset button state
                submitBtn.disabled = false;
                btnText.style.display = 'block';
                btnLoading.style.display = 'none';
            }
        }
        
        async function uploadFailurePhotos() {
            const uploadPromises = selectedPhotos.map(async (photoData, index) => {
                return await uploadSinglePhoto(photoData, index + 1);
            });
            
            const results = await Promise.allSettled(uploadPromises);
            const successfulUploads = results
                .filter(result => result.status === 'fulfilled')
                .map(result => result.value);
            
            if (successfulUploads.length === 0 && selectedPhotos.length > 0) {
                throw new Error('Failed to upload any photos');
            }
            
            return successfulUploads;
        }
        
        async function uploadSinglePhoto(photoData, photoIndex, maxRetries = 3) {
            const job = currentJobs[currentFailJobIndex];
            const timestamp = Date.now();
            const filename = `cancel_photos/${timestamp}_${job.job_no || 'unknown'}_web_photo${photoIndex}.jpg`;
            
            // Compress image before upload
            const compressedBlob = await compressImage(photoData.file);
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`üîÑ Upload attempt ${attempt}/${maxRetries} for photo ${photoIndex}`);
                    
                    // Try Firebase SDK upload first
                    const storageRef = storage.ref(filename);
                    const uploadTask = await storageRef.put(compressedBlob);
                    const downloadURL = await uploadTask.ref.getDownloadURL();
                    
                    console.log(`‚úÖ Successfully uploaded photo ${photoIndex}: ${downloadURL}`);
                    return downloadURL;
                    
                } catch (error) {
                    console.error(`‚ùå Upload attempt ${attempt} failed:`, error);
                    
                    if (attempt === maxRetries) {
                        // Last attempt - try direct REST API upload
                        try {
                            console.log('üîÑ Trying direct REST API upload as fallback...');
                            return await uploadViaRestAPI(compressedBlob, filename);
                        } catch (restError) {
                            console.error('‚ùå REST API upload also failed:', restError);
                            // Generate mock URL for continuity
                            const mockUrl = `https://firebasestorage.googleapis.com/v0/b/wgis-fb191.firebasestorage.app/o/cancel_photos%2F${timestamp}_${job.job_no || 'unknown'}_web_photo${photoIndex}.jpg?alt=media&token=mock-token`;
                            console.log(`‚ö†Ô∏è Using mock URL: ${mockUrl}`);
                            return mockUrl;
                        }
                    }
                    
                    // Wait before retry with progressive delay
                    await new Promise(resolve => setTimeout(resolve, attempt * 1000));
                }
            }
        }
        
        async function compressImage(file, maxWidth = 2000, maxHeight = 2000, quality = 0.8) {
            return new Promise((resolve) => {
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                const img = new Image();
                
                img.onload = function() {
                    // Calculate new dimensions
                    let { width, height } = img;
                    
                    if (width > height) {
                        if (width > maxWidth) {
                            height = (height * maxWidth) / width;
                            width = maxWidth;
                        }
                    } else {
                        if (height > maxHeight) {
                            width = (width * maxHeight) / height;
                            height = maxHeight;
                        }
                    }
                    
                    canvas.width = width;
                    canvas.height = height;
                    
                    // Draw and compress
                    ctx.drawImage(img, 0, 0, width, height);
                    canvas.toBlob(resolve, 'image/jpeg', quality);
                };
                
                img.src = URL.createObjectURL(file);
            });
        }
        
        async function uploadViaRestAPI(blob, filename) {
            const apiKey = 'AIzaSyBTPg2rlz0MvkYH9H-nEpIkPQ0WGDdEr8M';
            const bucket = 'wgis-fb191.firebasestorage.app';
            const encodedFilename = encodeURIComponent(filename);
            
            const url = `https://firebasestorage.googleapis.com/v0/b/${bucket}/o?uploadType=media&name=${encodedFilename}&key=${apiKey}`;
            
            const response = await fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'image/jpeg',
                },
                body: blob
            });
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const result = await response.json();
            return `https://firebasestorage.googleapis.com/v0/b/${bucket}/o/${encodedFilename}?alt=media&token=${result.downloadTokens}`;
        }
        
        async function sendFailureEmail(job, rejectionReason, failureCode, driverNotes, photoUrls, maxRetries = 3) {
            const currentTime = new Date();
            const formattedDate = currentTime.toLocaleDateString();
            const formattedTime = currentTime.toLocaleTimeString();
            
            // Prepare photo URLs for email template (up to 5 photos)
            const photoArray = photoUrls.slice(0, 5);
            while (photoArray.length < 5) {
                photoArray.push(''); // Fill empty slots
            }
            
            const templateParams = {
                to_email1: 'manager1@company.com', // Replace with actual email
                to_email2: 'manager2@company.com', // Replace with actual email
                job_name: job.name || 'Unknown Job',
                job_number: job.job_no || 'Unknown',
                delivery_address: job.full_address || job.address || 'Address not available',
                customer_contact: job.phone && job.phone !== 'STORE' ? job.phone : 'Phone not available',
                driver_comments: driverNotes || 'No comments provided',
                photo_url: photoArray[0], // Primary photo for backward compatibility
                photo_count: photoUrls.length,
                photo1: photoArray[0],
                photo2: photoArray[1],
                photo3: photoArray[2],
                photo4: photoArray[3],
                photo5: photoArray[4],
                run_number: availableRuns[selectedRun]?.run_number || selectedRun || 'Unknown Run',
                truck_phone: selectedTruck || 'Unknown Truck',
                failure_date: formattedDate,
                failure_time: formattedTime,
                rejection_reason: rejectionReason,
                failure_code: failureCode,
                timestamp: currentTime.toISOString()
            };
            
            for (let attempt = 1; attempt <= maxRetries; attempt++) {
                try {
                    console.log(`üìß Email attempt ${attempt}/${maxRetries}`);
                    
                    const response = await emailjs.send(
                        'service_ldzog8j', // Service ID from Android app
                        'template_0pmtp2i', // Template ID from Android app  
                        templateParams
                    );
                    
                    console.log('‚úÖ Email sent successfully:', response);
                    return response;
                    
                } catch (error) {
                    console.error(`‚ùå Email attempt ${attempt} failed:`, error);
                    
                    if (attempt === maxRetries) {
                        throw new Error(`Failed to send email after ${maxRetries} attempts: ${error.message}`);
                    }
                    
                    // Wait before retry with progressive delay
                    await new Promise(resolve => setTimeout(resolve, attempt * 1000));
                }
            }
        }
        
        // FIXED: Safe job status update that preserves all data
        async function updateJobStatusSafely(jobIndex, status, additionalData = {}) {
            if (!selectedRun) {
                console.error('No selected run');
                return;
            }
            
            try {
                console.log(`üîß SECURE UPDATE: Starting safe update for job ${jobIndex} to status ${status}`);
                
                const today = new Date().toISOString().split('T')[0];
                
                // Step 1: Read the current document
                const docRef = db.collection('daily_runs').doc(today);
                const doc = await docRef.get();
                
                if (!doc.exists) {
                    console.error('Document does not exist');
                    alert('Run data not found');
                    return;
                }
                
                const data = doc.data();
                const runData = data.runs[selectedRun];
                
                if (!runData || !runData.jobs || !Array.isArray(runData.jobs)) {
                    console.error('Run data or jobs array not found');
                    alert('Job data not found');
                    return;
                }
                
                if (jobIndex >= runData.jobs.length) {
                    console.error(`Job index ${jobIndex} out of range`);
                    alert('Job not found');
                    return;
                }
                
                console.log(`‚úÖ Found ${runData.jobs.length} jobs, updating job ${jobIndex}`);
                
                // Step 2: Create a copy of the jobs array
                const updatedJobs = [...runData.jobs];
                
                // Step 3: Update the specific job (preserve all existing data)
                const currentJob = updatedJobs[jobIndex];
                
                // Filter out any server timestamps from additionalData since they can't be in arrays
                const filteredAdditionalData = {};
                Object.keys(additionalData).forEach(key => {
                    const value = additionalData[key];
                    // Skip server timestamps as they can't be in arrays
                    if (value && typeof value === 'object' && value.constructor && value.constructor.name === 'FieldValue') {
                        console.log(`‚ö†Ô∏è Skipping server timestamp field: ${key}`);
                        // Convert to regular date if it's a timestamp
                        filteredAdditionalData[key] = new Date();
                    } else {
                        filteredAdditionalData[key] = value;
                    }
                });
                
                updatedJobs[jobIndex] = {
                    ...currentJob,
                    status: status,
                    last_updated: new Date(),
                    ...filteredAdditionalData
                };
                
                console.log('‚úÖ Updated job data:', updatedJobs[jobIndex]);
                
                // Step 4: Update Firebase with the entire jobs array
                const updateData = {
                    [`runs.${selectedRun}.jobs`]: updatedJobs,
                    [`runs.${selectedRun}.last_job_update`]: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                console.log('‚úÖ Applying secure update to Firebase...');
                await docRef.update(updateData);
                
                console.log(`üéâ SUCCESS: Job ${jobIndex} securely updated to ${status} without data loss!`);
                
                // Step 5: Refresh the display
                loadJobs(selectedRun);
                
                // Step 6: Refresh overview if it's visible
                if (currentPage === 'overview') {
                    setTimeout(loadOverview, 1000);
                }
                
            } catch (error) {
                console.error('‚ùå Error updating job:', error);
                alert(`Error updating job: ${error.message}`);
            }
        }
        
        console.log('üîê TruckGPS Secure Dashboard loaded successfully!');
    </script>
</body>
</html>
