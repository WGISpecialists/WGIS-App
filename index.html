<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name=\"viewport\" content=\"width=device-width, initial-scale=1.0\">
    <title>üîê TruckGPS Secure Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Arial, sans-serif;
            background-color: #f5f5f5;
            color: #333;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .header {
            background: linear-gradient(135deg, #1976d2, #42a5f5);
            color: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 20px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
        }
        
        .security-notice {
            background: #2e7d32;
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 600;
        }
        
        .section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .section h2 {
            color: #1976d2;
            margin-bottom: 15px;
            font-size: 1.5rem;
        }

        /* Page Navigation */
        .page {
            display: none;
        }
        
        .page.active {
            display: block;
        }
        
        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 0;
            border-bottom: 2px solid #e0e0e0;
            margin-bottom: 20px;
        }
        
        .nav-btn {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .nav-btn:hover {
            background-color: #1565c0;
        }
        
        .nav-btn:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }
        
        .nav-btn.overview {
            background-color: #4caf50;
        }
        
        .nav-btn.overview:hover {
            background-color: #45a049;
        }
        
        .page-title {
            font-size: 1.5rem;
            font-weight: 600;
            color: #1976d2;
        }
        
        .breadcrumb {
            font-size: 0.9rem;
            color: #666;
            margin-top: 5px;
        }

        /* Passcode Modal */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.8);
        }
        
        .modal-content {
            background-color: white;
            margin: 10% auto;
            padding: 30px;
            border-radius: 12px;
            width: 90%;
            max-width: 400px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
        }
        
        .modal h3 {
            color: #1976d2;
            margin-bottom: 20px;
            font-size: 1.5rem;
        }
        
        .passcode-input {
            font-size: 2rem;
            text-align: center;
            padding: 15px;
            border: 3px solid #1976d2;
            border-radius: 8px;
            width: 200px;
            margin: 20px auto;
            letter-spacing: 10px;
            font-weight: bold;
        }
        
        .passcode-buttons {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            max-width: 250px;
            margin: 20px auto;
        }
        
        .passcode-btn {
            background: #1976d2;
            color: white;
            border: none;
            padding: 15px;
            border-radius: 8px;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .passcode-btn:hover {
            background: #1565c0;
            transform: scale(1.05);
        }
        
        .passcode-btn.clear {
            background: #f44336;
            grid-column: span 2;
        }
        
        .passcode-btn.enter {
            background: #4caf50;
        }
        
        .error-message {
            color: #f44336;
            margin-top: 10px;
            font-weight: 600;
        }

        /* Overview Page Styles */
        .overview-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        
        .overview-card {
            border: 2px solid #e0e0e0;
            border-radius: 12px;
            padding: 20px;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .overview-card.claimed {
            border-color: #4caf50;
            background: #f8fff8;
        }
        
        .overview-card.available {
            border-color: #2196f3;
            background: #f3f8ff;
        }
        
        .overview-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }
        
        .overview-run-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1976d2;
        }
        
        .overview-status {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }
        
        .overview-status.available {
            background-color: #2196f3;
        }
        
        .overview-status.claimed {
            background-color: #4caf50;
        }
        
        .overview-driver {
            font-size: 1.1rem;
            font-weight: 600;
            color: #2e7d32;
            margin-bottom: 10px;
        }
        
        .overview-progress {
            margin: 15px 0;
        }
        
        .progress-bar {
            width: 100%;
            height: 20px;
            background-color: #e0e0e0;
            border-radius: 10px;
            overflow: hidden;
            margin: 8px 0;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #81c784);
            transition: width 0.3s ease;
            border-radius: 10px;
        }
        
        .progress-text {
            font-size: 0.9rem;
            font-weight: 600;
            color: #666;
            text-align: center;
            margin-top: 5px;
        }
        
        .job-breakdown {
            display: flex;
            justify-content: space-around;
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid #e0e0e0;
        }
        
        .job-stat {
            text-align: center;
        }
        
        .job-stat-number {
            font-size: 1.5rem;
            font-weight: bold;
            margin-bottom: 5px;
        }
        
        .job-stat-number.pending { color: #2196f3; }
        .job-stat-number.started { color: #ff9800; }
        .job-stat-number.completed { color: #4caf50; }
        .job-stat-number.failed { color: #f44336; }
        
        .job-stat-label {
            font-size: 0.8rem;
            color: #666;
            text-transform: uppercase;
        }
        
        .last-update {
            font-size: 0.8rem;
            color: #999;
            margin-top: 10px;
            text-align: center;
        }

        /* Rest of existing styles... */
        .truck-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }
        
        .truck-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .truck-card:hover {
            border-color: #1976d2;
            background-color: #f3f8ff;
        }
        
        .truck-card.selected {
            border-color: #1976d2;
            background-color: #e3f2fd;
        }
        
        .truck-icon {
            font-size: 2rem;
            margin-bottom: 10px;
        }
        
        .truck-name {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .runs-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
        }
        
        .run-card {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .run-card:hover {
            border-color: #1976d2;
        }
        
        .run-card.selected {
            border-color: #1976d2;
            background-color: #e3f2fd;
        }
        
        .run-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .run-number {
            font-size: 1.3rem;
            font-weight: 600;
            color: #1976d2;
        }
        
        .run-status {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.9rem;
            font-weight: 600;
            color: white;
        }
        
        .run-status.available {
            background-color: #4caf50;
        }
        
        .run-status.claimed {
            background-color: #ff9800;
        }
        
        .run-name {
            font-size: 1.1rem;
            margin-bottom: 8px;
        }
        
        .run-info {
            color: #666;
            font-size: 0.9rem;
        }
        
        .claim-btn {
            background-color: #1976d2;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            margin-top: 10px;
        }
        
        .claim-btn:hover {
            background-color: #1565c0;
        }
        
        .claimed-badge {
            background-color: #4caf50;
            color: white;
            padding: 5px 10px;
            border-radius: 4px;
            font-size: 0.9rem;
            font-weight: 600;
        }
        
        .job-list {
            max-height: 500px;
            overflow-y: auto;
        }
        
        .job-card {
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            background: white;
        }
        
        .job-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 10px;
        }
        
        .job-number {
            font-weight: 600;
            color: #1976d2;
            font-size: 1.1rem;
        }
        
        .job-status {
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
            color: white;
        }
        
        .job-status.pending {
            background-color: #2196f3;
        }
        
        .job-status.started {
            background-color: #ff9800;
        }
        
        .job-status.completed {
            background-color: #4caf50;
        }
        
        .job-customer {
            font-size: 1rem;
            font-weight: 500;
            margin-bottom: 5px;
        }
        
        .job-address {
            color: #666;
            margin-bottom: 5px;
        }
        
        .job-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .job-btn {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            transition: all 0.3s ease;
        }
        
        .job-btn:hover {
            transform: translateY(-1px);
        }
        
        .btn-start {
            background-color: #1976d2;
            color: white;
        }
        
        .btn-complete {
            background-color: #4caf50;
            color: white;
        }
        
        .btn-fail {
            background-color: #f44336;
            color: white;
        }
        
        .btn-call {
            background-color: #2196f3;
            color: white;
        }
        
        .btn-restore {
            background-color: #ff9800;
            color: white;
        }
        
        .btn-restore:hover {
            background-color: #f57c00;
        }
        
        .job-card.completed {
            border-left: 4px solid #4caf50;
            background: #f8fff8;
        }
        
        .job-card.failed {
            border-left: 4px solid #f44336;
            background: #fff8f8;
        }
        
        .job-notes {
            background: #f5f5f5;
            padding: 8px;
            border-radius: 4px;
            margin-top: 8px;
            font-style: italic;
            color: #666;
            font-size: 0.9rem;
        }
        
        .loading {
            text-align: center;
            padding: 20px;
            color: #666;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üîê TruckGPS Secure Dashboard</h1>
            <p>Secure truck selection, run management, and job tracking</p>
        </div>
        
        <div class="security-notice">
            üîê SECURE MODE: Passcode protection enabled ‚Ä¢ Session persistence ‚Ä¢ Real-time overview
        </div>
        
        <!-- Navigation Header -->
        <div class="nav-header">
            <button class="nav-btn" id="backBtn" onclick="goBack()" disabled>‚Üê Back</button>
            <div class="page-info">
                <div class="page-title" id="pageTitle">Run Overview</div>
                <div class="breadcrumb" id="breadcrumb">Real-time status</div>
            </div>
            <div>
                <button class="nav-btn" id="resetBtn" onclick="resetToTruckSelection()">üè† Home</button>
            </div>
        </div>
        
        <!-- Overview Page -->
        <div class="page active" id="overviewPage">
            <div class="section">
                <h2>üìä Live Run Overview</h2>
                <div class="overview-grid" id="overviewGrid">
                    <div class="loading">Loading run overview...</div>
                </div>
            </div>
        </div>
        
        <!-- Truck Selection Page -->
        <div class="page" id="truckSelectionPage">
            <div class="section">
                <div class="truck-grid" id="truckGrid">
                    <div class="loading">Loading trucks...</div>
                </div>
            </div>
        </div>
        
        <!-- Runs Selection Page -->
        <div class="page" id="runsSelectionPage">
            <div class="section">
                <div class="runs-grid" id="runsGrid">
                    <div class="loading">Loading runs...</div>
                </div>
            </div>
        </div>
        
        <!-- Job Management Page -->
        <div class="page" id="jobManagementPage">
            <div class="section">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 id="jobSectionTitle">Active Jobs</h2>
                    <div>
                        <button class="nav-btn" id="toggleJobsBtn" onclick="toggleJobView()">üìã View Completed/Failed</button>
                        <button class="nav-btn" id="refreshJobsBtn" onclick="refreshJobs()" style="background-color: #4caf50;">üîÑ Refresh</button>
                    </div>
                </div>
                <div class="job-list" id="jobList">
                    <div class="loading">Loading jobs...</div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Passcode Modal -->
    <div id="passcodeModal" class="modal">
        <div class="modal-content">
            <h3>üîê Enter Passcode</h3>
            <p>Enter 4-digit passcode to claim run</p>
            <input type="password" id="passcodeInput" class="passcode-input" maxlength="4" readonly>
            <div class="passcode-buttons">
                <button class="passcode-btn" onclick="addDigit('1')">1</button>
                <button class="passcode-btn" onclick="addDigit('2')">2</button>
                <button class="passcode-btn" onclick="addDigit('3')">3</button>
                <button class="passcode-btn" onclick="addDigit('4')">4</button>
                <button class="passcode-btn" onclick="addDigit('5')">5</button>
                <button class="passcode-btn" onclick="addDigit('6')">6</button>
                <button class="passcode-btn" onclick="addDigit('7')">7</button>
                <button class="passcode-btn" onclick="addDigit('8')">8</button>
                <button class="passcode-btn" onclick="addDigit('9')">9</button>
                <button class="passcode-btn clear" onclick="clearPasscode()">Clear</button>
                <button class="passcode-btn" onclick="addDigit('0')">0</button>
            </div>
            <button class="passcode-btn enter" onclick="submitPasscode()">Enter</button>
            <div id="passcodeError" class="error-message"></div>
        </div>
    </div>
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-storage-compat.js"></script>
    
    <script>
        // Firebase Configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBTPg2rlz0MvkYH9H-nEpIkPQ0WGDdEr8M",
            authDomain: "wgis-fb191.firebaseapp.com",
            projectId: "wgis-fb191",
            storageBucket: "wgis-fb191.firebasestorage.app",
            messagingSenderId: "858064992862",
            appId: "1:858064992862:android:6c50005973aa483b4a52cf"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Global state
        let selectedTruck = null;
        let selectedRun = null;
        let availableRuns = {};
        let currentJobs = {};
        let pendingRunKey = null;
        let showingCompletedJobs = false;
        
        // Page navigation state
        let currentPage = 'overview'; // Start with overview
        
        // Security
        const PASSCODE = '1289';
        
        // Default truck list
        const defaultTrucks = [
            '532 RXW',
            '660 WWG', 
            '723 VMV',
            'XQ44 TB',
            'RENTAL TRUCK 1',
            'RENTAL TRUCK 2',
            'UTE'
        ];
        
        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            restoreSession();
            loadTrucks();
            loadOverview();
            updatePageNavigation();
            
            // Auto-refresh overview every 30 seconds
            setInterval(loadOverview, 30000);
        });
        
        // Security functions
        function showPasscodeModal(runKey) {
            pendingRunKey = runKey;
            document.getElementById('passcodeModal').style.display = 'block';
            document.getElementById('passcodeInput').value = '';
            document.getElementById('passcodeError').textContent = '';
        }
        
        function hidePasscodeModal() {
            document.getElementById('passcodeModal').style.display = 'none';
            pendingRunKey = null;
        }
        
        function addDigit(digit) {
            const input = document.getElementById('passcodeInput');
            if (input.value.length < 4) {
                input.value += digit;
                if (input.value.length === 4) {
                    setTimeout(submitPasscode, 200);
                }
            }
        }
        
        function clearPasscode() {
            document.getElementById('passcodeInput').value = '';
            document.getElementById('passcodeError').textContent = '';
        }
        
        function submitPasscode() {
            const input = document.getElementById('passcodeInput');
            const error = document.getElementById('passcodeError');
            
            if (input.value === PASSCODE) {
                if (pendingRunKey) {
                    proceedWithClaim(pendingRunKey);
                }
                hidePasscodeModal();
            } else {
                error.textContent = 'Incorrect passcode. Try again.';
                input.value = '';
                // Shake effect
                input.style.animation = 'shake 0.5s';
                setTimeout(() => { input.style.animation = ''; }, 500);
            }
        }
        
        // Add shake animation to CSS (we'll add this dynamically)
        const style = document.createElement('style');
        style.textContent = `
            @keyframes shake {
                0%, 100% { transform: translateX(0); }
                25% { transform: translateX(-5px); }
                75% { transform: translateX(5px); }
            }
        `;
        document.head.appendChild(style);
        
        // Session persistence functions
        function saveSession() {
            const sessionData = {
                selectedTruck,
                selectedRun,
                currentPage,
                timestamp: Date.now()
            };
            localStorage.setItem('truckgps_session', JSON.stringify(sessionData));
        }
        
        function restoreSession() {
            try {
                const sessionData = JSON.parse(localStorage.getItem('truckgps_session'));
                if (!sessionData) return;
                
                // Session expires after 8 hours
                const sessionAge = Date.now() - sessionData.timestamp;
                if (sessionAge > 8 * 60 * 60 * 1000) {
                    localStorage.removeItem('truckgps_session');
                    return;
                }
                
                // Restore session state
                selectedTruck = sessionData.selectedTruck;
                selectedRun = sessionData.selectedRun;
                currentPage = sessionData.currentPage;
                
                console.log('üîÑ Session restored:', sessionData);
                
                // Navigate to the correct page
                if (currentPage === 'truck-selection' && selectedTruck) {
                    showPage('truckSelectionPage');
                } else if (currentPage === 'runs-selection' && selectedTruck) {
                    showPage('runsSelectionPage');
                    setTimeout(() => loadRuns(), 100);
                } else if (currentPage === 'job-management' && selectedTruck && selectedRun) {
                    showPage('jobManagementPage');
                    setTimeout(() => {
                        loadRuns().then(() => loadJobs(selectedRun));
                    }, 100);
                } else {
                    // Default to overview
                    currentPage = 'overview';
                    showPage('overviewPage');
                }
                
            } catch (error) {
                console.error('Error restoring session:', error);
                localStorage.removeItem('truckgps_session');
            }
        }
        
        function clearSession() {
            localStorage.removeItem('truckgps_session');
        }
        
        // Overview functions
        async function loadOverview() {
            const overviewGrid = document.getElementById('overviewGrid');
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const runsDoc = await db.collection('daily_runs').doc(today).get();
                
                if (runsDoc.exists) {
                    const data = runsDoc.data();
                    availableRuns = data.runs || {};
                    displayOverview();
                } else {
                    overviewGrid.innerHTML = '<div class="loading">No runs available for today</div>';
                }
            } catch (error) {
                console.error('Error loading overview:', error);
                overviewGrid.innerHTML = '<div class="loading">Error loading overview</div>';
            }
        }
        
        function displayOverview() {
            const overviewGrid = document.getElementById('overviewGrid');
            overviewGrid.innerHTML = '';
            
            if (Object.keys(availableRuns).length === 0) {
                overviewGrid.innerHTML = '<div class="loading">No runs available</div>';
                return;
            }
            
            Object.entries(availableRuns).forEach(([runKey, runData]) => {
                const overviewCard = document.createElement('div');
                const isAvailable = !runData.claimed_by;
                overviewCard.className = `overview-card ${isAvailable ? 'available' : 'claimed'}`;
                
                const runNumber = runData.run_number || runKey;
                const jobCount = runData.job_count || 0;
                
                // Calculate job statistics
                let jobStats = { pending: 0, started: 0, completed: 0, failed: 0 };
                let progressPercentage = 0;
                
                if (runData.jobs && Array.isArray(runData.jobs)) {
                    runData.jobs.forEach(job => {
                        const status = job.status || 'pending';
                        if (jobStats.hasOwnProperty(status)) {
                            jobStats[status]++;
                        }
                    });
                    
                    const totalCompleted = jobStats.completed + jobStats.failed;
                    progressPercentage = jobCount > 0 ? Math.round((totalCompleted / jobCount) * 100) : 0;
                }
                
                const statusClass = isAvailable ? 'available' : 'claimed';
                const statusText = isAvailable ? 'AVAILABLE' : 'CLAIMED';
                const driverText = runData.driver_name || runData.claimed_by || 'Unassigned';
                
                // Format last update time
                let lastUpdateText = 'No updates';
                if (runData.last_job_update) {
                    const lastUpdate = runData.last_job_update.toDate ? runData.last_job_update.toDate() : new Date(runData.last_job_update);
                    lastUpdateText = `Updated ${lastUpdate.toLocaleTimeString()}`;
                }
                
                overviewCard.innerHTML = `
                    <div class="overview-header">
                        <div class="overview-run-number">Run ${runNumber}</div>
                        <div class="overview-status ${statusClass}">${statusText}</div>
                    </div>
                    ${!isAvailable ? `<div class="overview-driver">üë§ ${driverText}</div>` : ''}
                    <div class="overview-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progressPercentage}%"></div>
                        </div>
                        <div class="progress-text">${progressPercentage}% Complete (${jobStats.completed + jobStats.failed}/${jobCount} jobs)</div>
                    </div>
                    <div class="job-breakdown">
                        <div class="job-stat">
                            <div class="job-stat-number pending">${jobStats.pending}</div>
                            <div class="job-stat-label">Pending</div>
                        </div>
                        <div class="job-stat">
                            <div class="job-stat-number started">${jobStats.started}</div>
                            <div class="job-stat-label">Started</div>
                        </div>
                        <div class="job-stat">
                            <div class="job-stat-number completed">${jobStats.completed}</div>
                            <div class="job-stat-label">Complete</div>
                        </div>
                        <div class="job-stat">
                            <div class="job-stat-number failed">${jobStats.failed}</div>
                            <div class="job-stat-label">Failed</div>
                        </div>
                    </div>
                    <div class="last-update">${lastUpdateText}</div>
                `;
                
                overviewGrid.appendChild(overviewCard);
            });
        }
        
        function showOverview() {
            currentPage = 'overview';
            showPage('overviewPage');
            loadOverview();
            saveSession();
        }
        
        // Page navigation functions
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // Show selected page
            document.getElementById(pageId).classList.add('active');
            
            // Update navigation state
            updatePageNavigation();
        }
        
        function updatePageNavigation() {
            const backBtn = document.getElementById('backBtn');
            const pageTitle = document.getElementById('pageTitle');
            const breadcrumb = document.getElementById('breadcrumb');
            
            switch(currentPage) {
                case 'overview':
                    backBtn.disabled = true;
                    pageTitle.textContent = 'Run Overview';
                    breadcrumb.textContent = 'Real-time status';
                    break;
                case 'truck-selection':
                    backBtn.disabled = false;
                    pageTitle.textContent = 'Select Your Truck';
                    breadcrumb.textContent = 'Step 1 of 3';
                    break;
                case 'runs-selection':
                    backBtn.disabled = false;
                    pageTitle.textContent = `Available Runs - ${selectedTruck}`;
                    breadcrumb.textContent = 'Step 2 of 3';
                    break;
                case 'job-management':
                    backBtn.disabled = false;
                    pageTitle.textContent = `Job Management - Run ${availableRuns[selectedRun]?.run_number || selectedRun}`;
                    breadcrumb.textContent = 'Step 3 of 3 - Managing Jobs';
                    break;
            }
        }
        
        function goBack() {
            switch(currentPage) {
                case 'truck-selection':
                    currentPage = 'overview';
                    showPage('overviewPage');
                    break;
                case 'runs-selection':
                    currentPage = 'truck-selection';
                    selectedTruck = null;
                    showPage('truckSelectionPage');
                    break;
                case 'job-management':
                    currentPage = 'runs-selection';
                    selectedRun = null;
                    showPage('runsSelectionPage');
                    break;
            }
            saveSession();
        }
        
        function resetToTruckSelection() {
            currentPage = 'truck-selection';
            selectedTruck = null;
            selectedRun = null;
            availableRuns = {};
            currentJobs = {};
            showPage('truckSelectionPage');
            
            // Clear session
            clearSession();
            
            // Clear truck selection UI
            document.querySelectorAll('.truck-card').forEach(card => {
                card.classList.remove('selected');
            });
        }
        
        // Load available trucks
        async function loadTrucks() {
            try {
                // Try to load trucks from Firebase first
                const trucksDoc = await db.collection('config').doc('trucks').get();
                
                let trucks = defaultTrucks;
                if (trucksDoc.exists) {
                    const trucksData = trucksDoc.data();
                    if (trucksData.available_trucks && trucksData.available_trucks.length > 0) {
                        trucks = trucksData.available_trucks.map(truck => 
                            typeof truck === 'object' ? truck.rego : truck
                        );
                    }
                }
                
                displayTrucks(trucks);
            } catch (error) {
                console.error('Error loading trucks:', error);
                displayTrucks(defaultTrucks);
            }
        }
        
        // Display truck selection
        function displayTrucks(trucks) {
            const truckGrid = document.getElementById('truckGrid');
            truckGrid.innerHTML = '';
            
            trucks.forEach(truck => {
                const truckCard = document.createElement('div');
                truckCard.className = 'truck-card';
                truckCard.innerHTML = `
                    <div class="truck-icon">üöõ</div>
                    <div class="truck-name">${truck}</div>
                `;
                truckCard.onclick = () => selectTruck(truck);
                truckGrid.appendChild(truckCard);
            });
        }
        
        // Select truck
        function selectTruck(truck) {
            selectedTruck = truck;
            
            // Update UI
            document.querySelectorAll('.truck-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.truck-card').classList.add('selected');
            
            // Navigate to runs selection page
            currentPage = 'runs-selection';
            showPage('runsSelectionPage');
            
            // Save session
            saveSession();
            
            // Load runs for this date
            loadRuns();
        }
        
        // Load available runs
        async function loadRuns() {
            if (!selectedTruck) return;
            
            const runsGrid = document.getElementById('runsGrid');
            runsGrid.innerHTML = '<div class="loading">Loading runs...</div>';
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const runsDoc = await db.collection('daily_runs').doc(today).get();
                
                if (runsDoc.exists) {
                    const data = runsDoc.data();
                    availableRuns = data.runs || {};
                    displayRuns();
                } else {
                    runsGrid.innerHTML = '<div class="loading">No runs available for today</div>';
                }
            } catch (error) {
                console.error('Error loading runs:', error);
                runsGrid.innerHTML = '<div class="loading">Error loading runs</div>';
            }
        }
        
        // Display runs
        function displayRuns() {
            const runsGrid = document.getElementById('runsGrid');
            runsGrid.innerHTML = '';
            
            if (Object.keys(availableRuns).length === 0) {
                runsGrid.innerHTML = '<div class="loading">No runs available</div>';
                return;
            }
            
            Object.entries(availableRuns).forEach(([runKey, runData]) => {
                const runCard = document.createElement('div');
                runCard.className = 'run-card';
                
                const runNumber = runData.run_number || runKey;
                const jobCount = runData.job_count || 0;
                const isAvailable = !runData.claimed_by;
                const isClaimedByMe = runData.driver_name === selectedTruck;
                
                let statusClass = 'available';
                let statusText = 'AVAILABLE';
                let actionButton = `<button class="claim-btn" onclick="claimRun('${runKey}')">üîê Secure Claim</button>`;
                
                if (runData.claimed_by) {
                    if (isClaimedByMe) {
                        statusClass = 'available';
                        statusText = 'YOURS';
                        actionButton = '<div class="claimed-badge">Your Run</div>';
                    } else {
                        statusClass = 'claimed';
                        statusText = `CLAIMED BY ${runData.driver_name || runData.claimed_by}`;
                        actionButton = '';
                    }
                }
                
                runCard.innerHTML = `
                    <div class="run-header">
                        <div class="run-number">Run ${runNumber}</div>
                        <div class="run-status ${statusClass}">${statusText}</div>
                    </div>
                    <div class="run-name">${runData.run_name || 'Unknown Run'}</div>
                    <div class="run-info">${jobCount} jobs</div>
                    ${actionButton}
                `;
                
                if (isClaimedByMe) {
                    runCard.onclick = () => selectRun(runKey, runData);
                }
                
                runsGrid.appendChild(runCard);
            });
        }
        
        // Claim a run (with passcode protection)
        function claimRun(runKey) {
            if (!selectedTruck) return;
            showPasscodeModal(runKey);
        }
        
        // Proceed with claiming after passcode verification
        async function proceedWithClaim(runKey) {
            try {
                const today = new Date().toISOString().split('T')[0];
                await db.collection('daily_runs').doc(today).update({
                    [`runs.${runKey}.claimed_by`]: `web_${selectedTruck}`,
                    [`runs.${runKey}.driver_name`]: selectedTruck,
                    [`runs.${runKey}.claimed_at`]: firebase.firestore.FieldValue.serverTimestamp(),
                    [`runs.${runKey}.status`]: 'claimed'
                });
                
                console.log(`üîê Run ${runKey} securely claimed by ${selectedTruck}`);
                
                // Automatically navigate to job management after claiming
                selectedRun = runKey;
                currentPage = 'job-management';
                showPage('jobManagementPage');
                
                // Save session
                saveSession();
                
                loadJobs(runKey);
                
            } catch (error) {
                console.error('Error claiming run:', error);
                alert('Error claiming run. Please try again.');
            }
        }
        
        // Select and load run jobs
        async function selectRun(runKey, runData) {
            selectedRun = runKey;
            
            // Update UI
            document.querySelectorAll('.run-card').forEach(card => {
                card.classList.remove('selected');
            });
            event.target.closest('.run-card').classList.add('selected');
            
            // Navigate to job management page
            currentPage = 'job-management';
            showPage('jobManagementPage');
            
            // Save session
            saveSession();
            
            // Load jobs for this run
            loadJobs(runKey);
        }
        
        // Load jobs for selected run
        async function loadJobs(runKey) {
            const jobList = document.getElementById('jobList');
            jobList.innerHTML = '<div class="loading">Loading jobs...</div>';
            
            try {
                const today = new Date().toISOString().split('T')[0];
                const jobsDoc = await db.collection('daily_runs').doc(today).get();
                
                if (jobsDoc.exists) {
                    const data = jobsDoc.data();
                    const runData = data.runs[runKey];
                    if (runData && runData.jobs) {
                        currentJobs = runData.jobs;
                        displayJobs();
                    } else {
                        jobList.innerHTML = '<div class="loading">No jobs found for this run</div>';
                    }
                } else {
                    jobList.innerHTML = '<div class="loading">No jobs available</div>';
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
                jobList.innerHTML = '<div class="loading">Error loading jobs</div>';
            }
        }
        
        // Toggle between active and completed/failed jobs
        function toggleJobView() {
            showingCompletedJobs = !showingCompletedJobs;
            const toggleBtn = document.getElementById('toggleJobsBtn');
            const sectionTitle = document.getElementById('jobSectionTitle');
            
            if (showingCompletedJobs) {
                toggleBtn.textContent = 'üìã View Active Jobs';
                sectionTitle.textContent = 'Completed & Failed Jobs';
            } else {
                toggleBtn.textContent = 'üìã View Completed/Failed';
                sectionTitle.textContent = 'Active Jobs';
            }
            
            displayJobs();
        }
        
        // Refresh jobs (reload from Firebase)
        function refreshJobs() {
            if (selectedRun) {
                loadJobs(selectedRun);
            }
        }
        
        // Display jobs (now with toggle support)
        function displayJobs() {
            const jobList = document.getElementById('jobList');
            jobList.innerHTML = '';
            
            if (!currentJobs || currentJobs.length === 0) {
                jobList.innerHTML = '<div class="loading">No jobs available</div>';
                return;
            }
            
            // Filter jobs based on current view
            let jobsToShow;
            if (showingCompletedJobs) {
                jobsToShow = currentJobs.filter(job => 
                    job.status === 'completed' || job.status === 'failed'
                );
            } else {
                jobsToShow = currentJobs.filter(job => 
                    job.status === 'pending' || job.status === 'started'
                );
            }
            
            if (jobsToShow.length === 0) {
                const message = showingCompletedJobs ? 
                    'No completed or failed jobs' : 
                    'No active jobs';
                jobList.innerHTML = `<div class="loading">${message}</div>`;
                return;
            }
            
            jobsToShow.forEach((job) => {
                // Find original index in currentJobs array
                const originalIndex = currentJobs.findIndex(j => 
                    j.job_no === job.job_no && j.name === job.name
                );
                
                const jobCard = document.createElement('div');
                jobCard.className = `job-card ${job.status}`;
                
                const status = job.status || 'pending';
                let statusClass = status;
                
                const phoneDisplay = job.phone && job.phone !== 'STORE' ? job.phone : null;
                
                // Format completion/failure time
                let timeInfo = '';
                if (job.completed_at || job.failed_at) {
                    const timestamp = job.completed_at || job.failed_at;
                    const time = timestamp.toDate ? timestamp.toDate() : new Date(timestamp);
                    timeInfo = `<div class="job-address">üïí ${status === 'completed' ? 'Completed' : 'Failed'} at ${time.toLocaleTimeString()}</div>`;
                }
                
                // Show driver notes if available
                let notesDisplay = '';
                if (job.driver_notes && job.driver_notes.trim()) {
                    notesDisplay = `<div class="job-notes">üí¨ Notes: ${job.driver_notes}</div>`;
                }
                
                // Show failure reason if available
                let failureDisplay = '';
                if (job.failure_reason && job.failure_reason.trim()) {
                    failureDisplay = `<div class="job-notes">‚ùå Failure reason: ${job.failure_reason}</div>`;
                }
                
                jobCard.innerHTML = `
                    <div class="job-header">
                        <div class="job-number">#${job.job_no || (originalIndex + 1)}</div>
                        <div class="job-status ${statusClass}">${status.toUpperCase()}</div>
                    </div>
                    <div class="job-customer">${job.name || 'Unknown Customer'}</div>
                    <div class="job-address">${job.full_address || job.address || 'No address'}</div>
                    ${job.product ? `<div class="job-address">üì¶ ${job.product}</div>` : ''}
                    ${job.time ? `<div class="job-address">‚è∞ ${job.time}</div>` : ''}
                    ${phoneDisplay ? `<div class="job-address">üìû ${phoneDisplay}</div>` : ''}
                    ${timeInfo}
                    ${notesDisplay}
                    ${failureDisplay}
                    <div class="job-actions">
                        ${!showingCompletedJobs && phoneDisplay ? `<button class="job-btn btn-call" onclick="callCustomer('${phoneDisplay}', '${job.name}')">Call</button>` : ''}
                        ${!showingCompletedJobs && status === 'pending' ? `<button class="job-btn btn-start" onclick="startJob(${originalIndex})">Start</button>` : ''}
                        ${!showingCompletedJobs && status === 'started' ? `<button class="job-btn btn-complete" onclick="completeJob(${originalIndex})">Complete</button>` : ''}
                        ${!showingCompletedJobs && status === 'started' ? `<button class="job-btn btn-fail" onclick="failJob(${originalIndex})">Fail</button>` : ''}
                        ${showingCompletedJobs ? `<button class="job-btn btn-restore" onclick="restoreJob(${originalIndex})">üîÑ Restore to Active</button>` : ''}
                    </div>
                `;
                
                jobList.appendChild(jobCard);
            });
        }
        
        // Restore a completed/failed job back to pending status
        async function restoreJob(jobIndex) {
            const job = currentJobs[jobIndex];
            const confirmMessage = `Restore "${job.name}" back to active jobs?\n\nThis will reset the job to pending status and remove completion/failure data.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }
            
            try {
                console.log(`üîÑ RESTORE: Restoring job ${jobIndex} (${job.name}) to pending status`);
                
                const today = new Date().toISOString().split('T')[0];
                const docRef = db.collection('daily_runs').doc(today);
                const doc = await docRef.get();
                
                if (!doc.exists) {
                    alert('Run data not found');
                    return;
                }
                
                const data = doc.data();
                const runData = data.runs[selectedRun];
                
                if (!runData || !runData.jobs || !Array.isArray(runData.jobs)) {
                    alert('Job data not found');
                    return;
                }
                
                // Create updated jobs array
                const updatedJobs = [...runData.jobs];
                const originalJob = updatedJobs[jobIndex];
                
                // Reset job to pending state, preserving core data
                updatedJobs[jobIndex] = {
                    ...originalJob,
                    status: 'pending',
                    completed_at: null,
                    failed_at: null,
                    driver_notes: '', // Clear notes
                    failure_reason: '', // Clear failure reason
                    last_updated: new Date()
                };
                
                console.log('‚úÖ Restored job data:', updatedJobs[jobIndex]);
                
                // Update Firebase
                const updateData = {
                    [`runs.${selectedRun}.jobs`]: updatedJobs,
                    [`runs.${selectedRun}.last_job_update`]: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                await docRef.update(updateData);
                console.log(`üéâ SUCCESS: Job "${job.name}" restored to pending status!`);
                
                // Refresh the display
                loadJobs(selectedRun);
                
                // Show success message
                setTimeout(() => {
                    alert(`‚úÖ Job "${job.name}" has been restored to active jobs!`);
                }, 500);
                
            } catch (error) {
                console.error('‚ùå Error restoring job:', error);
                alert(`Error restoring job: ${error.message}`);
            }
        }
        
        // Job actions
        function callCustomer(phone, name) {
            window.open(`tel:${phone}`, '_self');
        }
        
        async function startJob(jobIndex) {
            await updateJobStatusSafely(jobIndex, 'started');
        }
        
        async function completeJob(jobIndex) {
            const notes = prompt('Add completion notes (optional):');
            await updateJobStatusSafely(jobIndex, 'completed', { driver_notes: notes || '' });
        }
        
        async function failJob(jobIndex) {
            const reason = prompt('Failure reason:');
            if (reason) {
                await updateJobStatusSafely(jobIndex, 'failed', { 
                    driver_notes: reason,
                    failure_reason: reason 
                });
            }
        }
        
        // FIXED: Safe job status update that preserves all data
        async function updateJobStatusSafely(jobIndex, status, additionalData = {}) {
            if (!selectedRun) {
                console.error('No selected run');
                return;
            }
            
            try {
                console.log(`üîß SECURE UPDATE: Starting safe update for job ${jobIndex} to status ${status}`);
                
                const today = new Date().toISOString().split('T')[0];
                
                // Step 1: Read the current document
                const docRef = db.collection('daily_runs').doc(today);
                const doc = await docRef.get();
                
                if (!doc.exists) {
                    console.error('Document does not exist');
                    alert('Run data not found');
                    return;
                }
                
                const data = doc.data();
                const runData = data.runs[selectedRun];
                
                if (!runData || !runData.jobs || !Array.isArray(runData.jobs)) {
                    console.error('Run data or jobs array not found');
                    alert('Job data not found');
                    return;
                }
                
                if (jobIndex >= runData.jobs.length) {
                    console.error(`Job index ${jobIndex} out of range`);
                    alert('Job not found');
                    return;
                }
                
                console.log(`‚úÖ Found ${runData.jobs.length} jobs, updating job ${jobIndex}`);
                
                // Step 2: Create a copy of the jobs array
                const updatedJobs = [...runData.jobs];
                
                // Step 3: Update the specific job (preserve all existing data)
                const currentJob = updatedJobs[jobIndex];
                updatedJobs[jobIndex] = {
                    ...currentJob,
                    status: status,
                    last_updated: new Date(),
                    ...additionalData
                };
                
                console.log('‚úÖ Updated job data:', updatedJobs[jobIndex]);
                
                // Step 4: Update Firebase with the entire jobs array
                const updateData = {
                    [`runs.${selectedRun}.jobs`]: updatedJobs,
                    [`runs.${selectedRun}.last_job_update`]: firebase.firestore.FieldValue.serverTimestamp()
                };
                
                console.log('‚úÖ Applying secure update to Firebase...');
                await docRef.update(updateData);
                
                console.log(`üéâ SUCCESS: Job ${jobIndex} securely updated to ${status} without data loss!`);
                
                // Step 5: Refresh the display
                loadJobs(selectedRun);
                
                // Step 6: Refresh overview if it's visible
                if (currentPage === 'overview') {
                    setTimeout(loadOverview, 1000);
                }
                
            } catch (error) {
                console.error('‚ùå Error updating job:', error);
                alert(`Error updating job: ${error.message}`);
            }
        }
        
        console.log('üîê TruckGPS Secure Dashboard loaded successfully!');
    </script>
</body>
</html>